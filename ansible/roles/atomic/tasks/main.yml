- name: Upgrade pip
  pip:
    name: pip
    executable: pip3
    state: latest

- name: Install atomic-operator and posix harness (Python packages)
  pip:
    name:
      - atomic-operator
      - posixath
    executable: pip3
    state: present

- name: Ensure artifact directories exist (in synced /vagrant for host copy)
  file:
    path: /vagrant/artifacts
    state: directory
    owner: vagrant
    group: vagrant
    mode: '0755'

# -------------------------
# Настройка auditd
# -------------------------
- name: Install auditd
  apt:
    name: auditd
    state: present
    update_cache: yes

- name: Ensure audit rules directory exists
  file:
    path: /etc/audit/rules.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Configure auditd rules for command execution
  copy:
    dest: /etc/audit/rules.d/atomic.rules
    content: |
      # Audit all execve system calls (64-bit)
      -a always,exit -F arch=b64 -S execve -k exec_commands
      # Optional: monitor /opt/atomic-red-team directory changes
      -w /opt/atomic-red-team -p wa -k atomic_dir_changes
    owner: root
    group: root
    mode: '0644'

- name: Reload auditd rules
  command: augenrules --load
  become: yes

- name: Ensure auditd service is enabled and started
  service:
    name: auditd
    state: started
    enabled: yes

# -------------------------
# Atomic Red Team
# -------------------------
- name: Clone Atomic Red Team repository
  git:
    repo: 'https://github.com/redcanaryco/atomic-red-team.git'
    dest: /opt/atomic-red-team
    version: 'master'
    force: yes

- name: Place run_atomic.py helper
  copy:
    src: run_atomic.py
    dest: /usr/local/bin/run_atomic.py
    owner: root
    group: root
    mode: '0755'

- name: Place collect_artifacts.sh helper
  copy:
    src: collect_artifacts.sh
    dest: /usr/local/bin/collect_artifacts.sh
    owner: root
    group: root
    mode: '0755'

- name: Ensure run_atomic log file exists
  file:
    path: /var/log/atomic/last_run.log
    state: touch
    owner: root
    group: root
    mode: '0644'
